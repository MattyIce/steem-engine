<header>
	<div class="row header-row">
		<div class="col-md-6">
			<h1><%= data.account == SE.User.name ? 'MY' : '@' + data.account + "'s" %> TOKEN WALLET</h1>
			<span id="total-wallet-value">Est. Value: $<span id="wallet-value-amount">0</span> USD</span>
		</div>
		<div class="col-md-6">
			<div class="buttons">
				<% if(SE.User) { %>
					<button class="btn btn-primary" onclick="SE.ShowDialog('deposit_tokens');">DEPOSIT</button>
					<button class="btn btn-secondary" onclick="SE.ShowDialog('withdraw_tokens');">WITHDRAW</button>
					<div class="note">NOTE: There is a 1% fee on all deposits and withdrawals.</div>
				<% } %>
			</div>
		</div>
	</div>
</header>

<div class="container">
  <table id="balances_table" class="tokensTable <%= data.account == SE.User.name ? 'interactiveTable' : '' %>" data-sorting="true"></table>
</div>

<script>
	function IconColumn(value, options, rowdata) {
		return `<i class="fas fa-info-circle" onclick="SE.ShowDialog('token_info', SE.GetToken('${value}'));"></i>&nbsp;&nbsp;&nbsp;` +
			`<i class="fas fa-exchange-alt" onclick="SE.ShowMarket('${value}');"></i>&nbsp;&nbsp;&nbsp;` +
			`<i class="fas fa-share-square" onclick="SE.ShowSendTokenDialog('${value}', ${rowdata.balance});"></i>&nbsp;&nbsp;&nbsp;` +
			`<i class="fas fa-list-ul" onclick="SE.ShowHistory('${value}', '${rowdata.name}')"></i>`;
	}

	function SymbolColumn(value, options, rowdata) {
		var token = SE.GetToken(value);

		if(token && token.metadata && token.metadata.icon)
			return '<img class="icon" src="' + token.metadata.icon + '"/>';
		else
			return '';
	}

	function BalanceColumn(value, options, rowdata) { return addCommas(value) + ' ' + rowdata.symbol; }
	function USDValueColumn(value, options, rowdata) { return '<span class="' + (rowdata.priceChangePercent > 0 ? 'green' : (rowdata.priceChangePercent < 0 ? 'red' : '')) + '">' + usdFormat(value * SE.Tokens.find(t => t.symbol == rowdata.symbol).lastPrice, 2) + '</span>'; }
	function PctColumn(value, options, rowdata) { return '<span class="' + (value > 0 ? 'green' : (value < 0 ? 'red' : '')) + '">' + value.toFixed(2) + '%</span>'; }

	var data = <%= JSON.stringify(data.balances.filter(b => !Config.DISABLED_TOKENS.includes(b.symbol))) %>;

	data = data.map(d => {
		var token = SE.Tokens.find(t => t.symbol == d.symbol);

		return Object.assign(d, {
			name: token.name,
			lastPrice: token.lastPrice,
			priceChangePercent: token.priceChangePercent,
			usdValue: usdFormat(d.balance * token.lastPrice, 2)
		});
	});

	data.sort((a, b) => b.balance * b.lastPrice * window.steem_price - a.balance * a.lastPrice * window.steem_price);

	var totalInUsd = 0.00;
	data.forEach(function(o) {
		var raw = o.usdValue.replace('$', '').split(',').join('');
		var amount = parseFloat(raw);
		totalInUsd += amount;
	});

	$('#wallet-value-amount').text(addCommas(totalInUsd.toFixed(2)));

	$('#balances_table').footable({
		"columns": [
			{ "name": "symbol", "title": "", "classes": "icon", "formatter": SymbolColumn },
			{ "name": "symbol", "classes": "symbol", "title": "Symbol" },
			{ "name": "name", "title": "Token Name" },
			{ "name": "balance", "title": "Balance", "type": "number", "classes": "text-right", "formatter": BalanceColumn },
			{ "name": "balance", "title": "USD Value", "type": "number", "classes": "text-right bold", "formatter": USDValueColumn },
			{ "name": "priceChangePercent", "title": "% Chg", "type": "number", "classes": "text-right bold", "formatter": PctColumn },
			{ "name": "symbol", "title": "", "classes": "icons", "formatter": IconColumn }
		],
		"rows": data
	});
</script>
